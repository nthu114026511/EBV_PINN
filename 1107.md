# EVB_jump.py 檔案介紹

## 檔案概述

這是一個使用 **RK4 數值積分方法** 搭配 **LQ 腫瘤放射治療模型** 的 Python 模擬程式。它用來模擬：
- 連續時段的腫瘤增長與免疫反應動力學
- 分次放射治療事件導致的跳躍（突變）

---

## 參數設定

### 1. 生物學參數（ODE 系統）

| 參數 | 值 | 單位 | 意義 |
|------|-----|------|------|
| `r` | 0.10 | /day | Logistic 生長率 |
| `K` | 5.00 | 單位 | 攜帶容量（最大腫瘤體積） |
| `sigma0` | 0.01 | /day | 基礎轉移率（B→R） |
| `sigma1` | 0.20 | 無因次 | 殺死分數（被殺死的B轉化為R的比例） |
| `k12` | 0.05 | /day | R→E 轉移率 |
| `kc` | 0.15 | /day | E 清除率 |

### 2. 初值條件

| 狀態 | 初值 | 含義 |
|------|------|------|
| `B0` | 0.05 | 初始腫瘤細胞數 |
| `R0` | 0.00 | 初始已死亡腫瘤細胞數 |
| `E0` | 0.00 | 初始效應細胞數 |

### 3. LQ 模型參數（放射治療）

| 參數 | 值 | 單位 | 意義 |
|------|-----|------|------|
| `alpha` | 0.30 | 1/Gy | 腫瘤 alpha 係數（線性項） |
| `beta` | 0.03 | 1/Gy² | 腫瘤 beta 係數（二次項） |

存活分數計算公式：
$$SF = e^{-\alpha \cdot d - \beta \cdot d^2}$$

其中 $d$ 為照射劑量

### 4. 積分設定

| 參數 | 值 | 意義 |
|------|-----|------|
| `t0` | 0.0 | 模擬起始時間 |
| `tf` | 60.0 | 模擬結束時間 |
| `h` | 0.1 | RK4 基本步長 |

---

## 分次方案（跳躍點與劑量）

### 分次時刻與劑量表

| 分次 | 時刻 (day) | 劑量 (Gy) | 預期存活分數 |
|-----|-----------|----------|------------|
| 1 | 10.0 | 1.5 | $e^{-0.30 \times 1.5 - 0.03 \times 1.5^2} \approx 0.6068$ |
| 2 | 20.0 | 1.5 | $e^{-0.30 \times 1.5 - 0.03 \times 1.5^2} \approx 0.6068$ |
| 3 | 40.0 | 1.5 | $e^{-0.30 \times 1.5 - 0.03 \times 1.5^2} \approx 0.6068$ |

**總照射劑量**：4.5 Gy
**分次方式**：均勻分次（每次1.5 Gy）

### 跳躍機制說明

在每個時刻 $t_j$，當照射發生時：

1. **照射前狀態（minus）**：$(B^-, R^-, E^-)$
2. **存活分數計算**：$SF = e^{-\alpha d - \beta d^2}$
3. **照射後狀態（plus）**：
   - $B^+ = B^- \times SF$ （腫瘤細胞死亡）
   - $R^+ = R^- + \sigma_1 \times (B^- - B^+)$ （轉移到已死亡狀態）
   - $E^+ = E^-$ （效應細胞連續不變）

---

## 輸出結果

### 1. 圖表輸出
- **3 個子圖**，共享 x 軸（時間）
  - 第1圖：B（腫瘤細胞）隨時間變化
  - 第2圖：R（已死亡腫瘤細胞）隨時間變化
  - 第3圖：E（效應細胞）隨時間變化
- **垂直虛線**：標記每次分次位置（t = 10, 20, 40 day）

### 2. 數據導出（CSV 檔案）

**輸出路徑**：`./data/evb_training_data_jump.csv`

**CSV 欄位**：
| 欄位 | 說明 |
|------|------|
| `t` | 時間（天）|
| `B` | 腫瘤細胞數 |
| `R` | 已死亡腫瘤細胞數 |
| `E` | 效應細胞數 |

### 3. 分次事件表（控制台輸出）

程式會列印每次分次的詳細資訊，包含：
- `t`：分次時刻
- `dose`：照射劑量（Gy）
- `SF`：存活分數
- `dB_instant`：瞬時殺死的腫瘤細胞數（$B^- - B^+$）
- `R_gain`：轉移到 R 的細胞數（$\sigma_1 \times dB_{instant}$）

**範例輸出**：
```
         t  dose        SF  dB_instant  R_gain
      10.0   1.5  0.606531   0.xxxxxx  0.xxxxxx
      20.0   1.5  0.606531   0.xxxxxx  0.xxxxxx
      40.0   1.5  0.606531   0.xxxxxx  0.xxxxxx
```

---

## 核心演算法

### ODE 系統（連續段）

在跳躍之間，系統遵循以下微分方程：

$$\begin{align}
\frac{dB}{dt} &= r \cdot B \left(1 - \frac{B}{K}\right) \\
\frac{dR}{dt} &= \sigma_0 \cdot B - k_{12} \cdot R \\
\frac{dE}{dt} &= k_{12} \cdot R - k_c \cdot E
\end{align}$$

### 數值方法

- **RK4（Runge-Kutta 4 階）**：用於連續段積分
- **步長調整**：事件前自動縮步以精確對齊分次時刻
- **非負裁切**：防止數值誤差導致負值

---

## 程式流程

```
1. 初始化參數與初值條件
   ↓
2. 檢查分次時刻（t_frac）是否落在 [t0, tf] 內
   ↓
3. 分段積分：
   a. 從 t0 到第1個分次時刻
   b. RK4 數值積分
   c. 到達分次時刻 → 施加 LQ 跳躍
   d. 重複至最後一個分次
   e. 積分至 tf
   ↓
4. 輸出
   - 列印分次事件表
   - 繪製 B, R, E 圖表（標記分次位置）
   - 儲存 CSV 數據
```

---

## 重要注意事項

1. **時間間隔**：跳躍須落在 $(t_0, t_f)$ 內，邊界點會被忽略
2. **非負性**：所有狀態變數保證 ≥ 0（透過 `np.maximum`）
3. **輸出點密度**：每步 h=0.1 天，總共約 600+ 個時間點
4. **無單位制**：根據應用調整單位（如天、小時等）

---

